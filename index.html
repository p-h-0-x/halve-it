<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Darts Halve-It Scorer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #e94560;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .setup-section {
            max-width: 500px;
            margin: 0 auto 30px;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .setup-section h2 {
            margin-bottom: 15px;
            color: #3282b8;
        }

        .language-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .lang-btn {
            padding: 8px 16px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            background: rgba(0,0,0,0.3);
            color: white;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(50, 130, 184, 0.5);
        }

        .lang-btn.active {
            background: #3282b8;
            border-color: #bbe1fa;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .mode-option:hover {
            background: rgba(0,0,0,0.3);
        }

        .mode-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .mode-label {
            font-weight: 600;
        }

        .mode-description {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 10px;
        }

        .player-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .player-input input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #e94560;
            color: white;
        }

        .btn-primary:hover {
            background: #ff6b6b;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #00b894;
            color: white;
        }

        .btn-success:hover {
            background: #00d9a5;
        }

        .btn-danger {
            background: #d63031;
            color: white;
        }

        .btn-secondary {
            background: #636e72;
            color: white;
        }

        .btn-secondary:hover {
            background: #7d8a8f;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 14px;
        }

        .player-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .player-tag {
            background: #3282b8;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-tag button {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            font-size: 12px;
        }

        .game-board {
            max-width: 900px;
            margin: 0 auto;
            display: none;
        }

        .current-round {
            text-align: center;
            background: linear-gradient(135deg, #e94560, #ff6b6b);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .current-round h2 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .current-round p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .scores-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .scores-table th, .scores-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .scores-table th {
            background: rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .scores-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .round-name-cell {
            text-align: left !important;
            font-weight: 600;
            color: #bbe1fa;
        }

        .round-current {
            background: rgba(233, 69, 96, 0.3) !important;
        }

        .score-success {
            color: #00b894;
            font-weight: bold;
        }

        .score-fail {
            color: #ff6b6b;
        }

        .total-row {
            background: rgba(0,0,0,0.4) !important;
            font-size: 1.1em;
        }

        .total-row td {
            font-weight: bold;
            color: #f9d423;
        }

        .score-input-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .score-input-section h3 {
            margin-bottom: 15px;
            color: #3282b8;
        }

        .player-score-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-score-card {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .player-score-card h4 {
            margin-bottom: 10px;
            color: #bbe1fa;
        }

        .player-score-card .current-capital {
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 10px;
        }

        .score-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .score-row input[type="number"] {
            flex: 1;
            max-width: 120px;
            padding: 8px;
            border: none;
            border-radius: 5px;
            text-align: center;
            font-size: 16px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .winner-section {
            display: none;
            text-align: center;
            background: linear-gradient(135deg, #f9d423, #ff4e50);
            padding: 40px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .winner-section h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .winner-section .trophy {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .rules-section {
            max-width: 800px;
            margin: 30px auto;
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
        }

        .rules-section h3 {
            color: #3282b8;
            margin-bottom: 15px;
        }

        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .rule-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .rule-item strong {
            color: #e94560;
        }

        .hidden {
            display: none !important;
        }

        .reset-game-section {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
        }

        /* Dart Input Styles */
        .dart-input-btn {
            background: rgba(50, 130, 184, 0.3);
            border: 2px solid #3282b8;
            padding: 8px 12px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .dart-input-btn:hover {
            background: rgba(50, 130, 184, 0.5);
            transform: scale(1.1);
        }

        .dart-input-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .dart-input-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dart-input-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .dart-input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .dart-input-header h3 {
            color: #e94560;
            margin: 0;
        }

        .close-dart-input {
            background: #d63031;
            border: none;
            color: white;
            font-size: 24px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dart-input-current {
            text-align: center;
            margin-bottom: 20px;
        }

        .dart-input-current h4 {
            color: #3282b8;
            margin-bottom: 10px;
        }

        .darts-display {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .dart-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 60px;
            text-align: center;
            color: #00b894;
            font-weight: bold;
        }

        .dart-display.empty {
            color: #636e72;
        }

        .dart-total {
            font-size: 1.3em;
            color: #f9d423;
            margin-top: 10px;
        }

        .modifier-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .modifier-btn {
            padding: 12px 20px;
            border: 2px solid #3282b8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            transition: all 0.3s ease;
        }

        .modifier-btn:hover {
            background: rgba(50, 130, 184, 0.5);
        }

        .modifier-btn.active {
            background: #3282b8;
            border-color: #bbe1fa;
        }

        .number-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .number-btn {
            padding: 15px 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            transition: all 0.3s ease;
        }

        .number-btn:hover {
            background: rgba(233, 69, 96, 0.5);
            border-color: #e94560;
        }

        .number-btn.bull {
            grid-column: span 2;
            background: rgba(233, 69, 96, 0.3);
        }

        .dart-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Yahtzee Mode Styles */
        .hide-scores-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .hide-scores-btn:hover {
            background: rgba(0,0,0,0.7);
        }

        .score-hidden {
            filter: blur(8px);
            user-select: none;
        }

        .current-player-banner {
            text-align: center;
            background: linear-gradient(135deg, #3282b8, #0f4c75);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .current-player-banner h3 {
            font-size: 1.5em;
            margin: 0;
        }

        .contract-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .contract-btn {
            padding: 12px 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(0,0,0,0.3);
            color: white;
        }

        .contract-btn:hover:not(:disabled) {
            background: rgba(50, 130, 184, 0.5);
            border-color: #3282b8;
        }

        .contract-btn.selected {
            background: #3282b8;
            border-color: #bbe1fa;
        }

        .contract-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .contract-btn.scratched {
            background: rgba(214, 48, 49, 0.3);
        }

        .contract-btn.scratch-mode {
            background: rgba(214, 48, 49, 0.5);
            border-color: #d63031;
        }

        .scratch-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .scratch-section h4 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .scratch-mode-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .toggle-btn {
            padding: 10px 20px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            background: rgba(0,0,0,0.3);
            color: white;
        }

        .toggle-btn.active {
            background: #3282b8;
            border-color: #bbe1fa;
        }

        .toggle-btn.scratch-active {
            background: #d63031;
            border-color: #ff6b6b;
        }

        .yahtzee-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .cell-scratched {
            color: #636e72;
            text-decoration: line-through;
        }

        .cell-filled {
            color: #00b894;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .scores-table {
                font-size: 0.85em;
            }

            .scores-table th, .scores-table td {
                padding: 8px 5px;
            }

            .contract-selector {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .contract-btn {
                padding: 8px 5px;
                font-size: 12px;
            }

            .score-input-section {
                padding: 15px;
            }

            .yahtzee-actions {
                flex-direction: column;
            }

            .yahtzee-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>üéØ Darts Halve-It</h1>

    <!-- Setup Section -->
    <div class="setup-section" id="setupSection">
        <!-- Language Selector -->
        <div class="language-selector">
            <button class="lang-btn active" onclick="setLanguage('en')">üá¨üáß English</button>
            <button class="lang-btn" onclick="setLanguage('fr')">üá´üá∑ Fran√ßais</button>
            <button class="lang-btn" onclick="setLanguage('es')">üá™üá∏ Espa√±ol</button>
        </div>

        <h2 data-i18n="gameMode">Game Mode</h2>
        <div class="mode-selector">
            <label class="mode-option">
                <input type="radio" name="gameMode" value="classic" checked onchange="updateModeDescription()">
                <span class="mode-label" data-i18n="classic">Classic</span>
            </label>
            <label class="mode-option">
                <input type="radio" name="gameMode" value="yahtzee" onchange="updateModeDescription()">
                <span class="mode-label" data-i18n="freeChoice">Yahtzee Style</span>
            </label>
        </div>
        <p class="mode-description" id="modeDescription" data-i18n="classicDesc">Play contracts in order. Hit the target to add score, miss to halve your capital.</p>
        
        <h2 style="margin-top: 20px;" data-i18n="addPlayers">Add Players</h2>
        <div class="player-input">
            <input type="text" id="playerNameInput" data-i18n-placeholder="enterPlayerName" placeholder="Enter player name" onkeypress="if(event.key==='Enter')addPlayer()">
            <button class="btn-primary" onclick="addPlayer()" data-i18n="addPlayer">Add Player</button>
        </div>
        <div class="player-list" id="playerList"></div>
        <br>
        <button class="btn-success" onclick="startGame()" id="startBtn" style="display:none;" data-i18n="startGame">Start Game</button>
    </div>

    <!-- Game Board -->
    <div class="game-board" id="gameBoard">
        <!-- Hide Scores Button (Yahtzee mode only) -->
        <button class="hide-scores-btn hidden" id="hideScoresBtn" onclick="toggleScoreVisibility()">üëÅÔ∏è</button>

        <!-- Classic Mode: Current Round Display -->
        <div class="current-round" id="classicRoundDisplay">
            <h2 id="currentRoundName">Capital</h2>
            <p id="currentRoundDesc">First 3 darts - establish your starting score</p>
        </div>

        <!-- Yahtzee Mode: Current Player Display -->
        <div class="current-player-banner hidden" id="yahtzeePlayerDisplay">
            <h3 id="currentPlayerName">Player 1's Turn</h3>
            <p data-i18n="chooseContract">Choose a contract to fill or scratch</p>
        </div>

        <!-- Classic Mode: Score Input -->
        <div class="score-input-section" id="classicInputSection">
            <h3 data-i18n="enterScores">Enter Scores for Current Round</h3>
            <div class="player-score-inputs" id="scoreInputs"></div>
            <div class="action-buttons">
                <button class="btn-secondary" onclick="previousRound()" id="prevBtn" style="display:none;" data-i18n="previousRound">‚Üê Previous Round</button>
                <button class="btn-success" onclick="submitRound()" data-i18n="submitRound">Submit Round</button>
            </div>
        </div>

        <!-- Yahtzee Mode: Score Input -->
        <div class="score-input-section hidden" id="yahtzeeInputSection">
            <h3 data-i18n="enterYourScore">Enter Your Darts</h3>
            <div class="player-score-card" style="max-width: 400px; margin: 0 auto 20px;">
                <div class="score-row" style="flex-direction: column; align-items: stretch;">
                    <div id="yahtzeeDartsDisplay" style="margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px; text-align: center; min-height: 40px;">
                        <span style="color: #636e72;">No darts entered</span>
                    </div>
                    <button class="dart-input-btn" onclick="openDartInputYahtzee()" title="Enter darts" style="width: 100%;">üéØ <span data-i18n="enterDarts">Enter Your Darts</span></button>
                </div>
            </div>

            <div class="scratch-mode-toggle">
                <button class="toggle-btn active" id="fillModeBtn" onclick="toggleScratchMode(false)">
                    <span data-i18n="fillMode">Fill Contract</span>
                </button>
                <button class="toggle-btn" id="scratchModeBtn" onclick="toggleScratchMode(true)">
                    <span data-i18n="scratchMode">Scratch Contract</span>
                </button>
            </div>

            <h4 style="color: #3282b8; margin-bottom: 10px;" id="contractActionLabel" data-i18n="selectContract">Select Contract:</h4>
            <div class="contract-selector" id="contractSelector"></div>

            <div class="yahtzee-actions">
                <button class="btn-secondary" onclick="previousYahtzeeTurn()" id="yahtzeePrevBtn" style="display:none;" data-i18n="previousTurn">‚Üê Previous Turn</button>
                <button class="btn-success" onclick="submitYahtzeeChoice()" data-i18n="confirmChoice">Confirm Choice</button>
            </div>
        </div>

        <table class="scores-table">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>

        <!-- Reset Game Button Section -->
        <div class="reset-game-section">
            <button class="btn-danger" onclick="resetGame()" data-i18n="resetGame">Reset Game</button>
        </div>

        <div class="winner-section" id="winnerSection">
            <div class="trophy">üèÜ</div>
            <h2 id="winnerName">Winner!</h2>
            <p id="winnerScore"></p>
            <br>
            <button class="btn-secondary" onclick="editLastRound()" id="editScoresBtn" data-i18n="editScores">‚Üê Edit Scores</button>
            <button class="btn-primary" onclick="resetGame()" data-i18n="playAgain">Play Again</button>
        </div>
    </div>

    <!-- Dart Input Modal -->
    <div class="dart-input-modal" id="dartInputModal">
        <div class="dart-input-container">
            <div class="dart-input-header">
                <h3>üéØ <span data-i18n="enterDarts">Enter Your Darts</span></h3>
                <button class="close-dart-input" onclick="closeDartInput()">√ó</button>
            </div>

            <div class="dart-input-current">
                <h4 data-i18n="dartsThrown">Darts Thrown:</h4>
                <div class="darts-display">
                    <div class="dart-display empty" id="dart1Display">-</div>
                    <div class="dart-display empty" id="dart2Display">-</div>
                    <div class="dart-display empty" id="dart3Display">-</div>
                </div>
                <div class="dart-total">
                    <span data-i18n="total">Total</span>: <span id="dartTotalDisplay">0</span>
                </div>
            </div>

            <div class="modifier-buttons">
                <button class="modifier-btn active" id="singleBtn" onclick="setModifier('single')">Single</button>
                <button class="modifier-btn" id="doubleBtn" onclick="setModifier('double')">Double</button>
                <button class="modifier-btn" id="tripleBtn" onclick="setModifier('triple')">Triple</button>
            </div>

            <div class="number-grid">
                <button class="number-btn" onclick="addDart(1)">1</button>
                <button class="number-btn" onclick="addDart(2)">2</button>
                <button class="number-btn" onclick="addDart(3)">3</button>
                <button class="number-btn" onclick="addDart(4)">4</button>
                <button class="number-btn" onclick="addDart(5)">5</button>
                <button class="number-btn" onclick="addDart(6)">6</button>
                <button class="number-btn" onclick="addDart(7)">7</button>
                <button class="number-btn" onclick="addDart(8)">8</button>
                <button class="number-btn" onclick="addDart(9)">9</button>
                <button class="number-btn" onclick="addDart(10)">10</button>
                <button class="number-btn" onclick="addDart(11)">11</button>
                <button class="number-btn" onclick="addDart(12)">12</button>
                <button class="number-btn" onclick="addDart(13)">13</button>
                <button class="number-btn" onclick="addDart(14)">14</button>
                <button class="number-btn" onclick="addDart(15)">15</button>
                <button class="number-btn" onclick="addDart(16)">16</button>
                <button class="number-btn" onclick="addDart(17)">17</button>
                <button class="number-btn" onclick="addDart(18)">18</button>
                <button class="number-btn" onclick="addDart(19)">19</button>
                <button class="number-btn" onclick="addDart(20)">20</button>
                <button class="number-btn bull" onclick="addDart(25)">BULL (25)</button>
                <button class="number-btn" onclick="addDart(0)"><span data-i18n="miss">Miss</span></button>
            </div>

            <div class="dart-actions">
                <button class="btn-secondary" onclick="clearLastDart()">‚Üê <span data-i18n="undo">Undo</span></button>
                <button class="btn-secondary" onclick="clearAllDarts()"><span data-i18n="clear">Clear</span></button>
                <button class="btn-success" onclick="confirmDarts()">‚úì <span data-i18n="confirm">Confirm</span></button>
            </div>
        </div>
    </div>

    <!-- Rules Section -->
    <div class="rules-section">
        <h3 data-i18n="gameRules">üìã Game Rules</h3>
        <p style="margin-bottom: 15px;" data-i18n="rulesClassic"><strong>Classic:</strong> Hit the contract target to add your score to your capital. Miss it and your capital is halved!</p>
        <p style="margin-bottom: 15px;" data-i18n="rulesFreeChoice"><strong>Yahtzee Style:</strong> Choose where to register your score each turn. Scratch contracts you can't fill (score 0).</p>
        <div class="rules-grid" id="rulesGrid">
            <!-- Rules will be populated by JavaScript -->
        </div>
    </div>

    <script>
        // ==================== TRANSLATIONS ====================
        const translations = {
            en: {
                // Setup
                gameMode: "Game Mode",
                classic: "Classic",
                freeChoice: "Yahtzee Style",
                classicDesc: "Play contracts in order. Hit the target to add score, miss to halve your capital.",
                freeChoiceDesc: "Choose where to register your score. Fill or scratch contracts freely.",
                addPlayers: "Add Players",
                enterPlayerName: "Enter player name",
                addPlayer: "Add Player",
                startGame: "Start Game",
                
                // Game
                enterScores: "Enter Scores for Current Round",
                enterYourScore: "Enter Your Score",
                score: "Score:",
                currentCapital: "Current capital:",
                startingRound: "Starting round",
                previousRound: "‚Üê Previous Round",
                previousTurn: "‚Üê Previous Turn",
                submitRound: "Submit Round",
                confirmChoice: "Confirm Choice",
                resetGame: "Reset Game",
                chooseContract: "Choose a contract to fill or scratch",
                selectContractFill: "Select Contract to Fill:",
                scratchContract: "Or Scratch a Contract (score 0):",
                selectContract: "Select Contract:",
                fillMode: "Fill Contract",
                scratchMode: "Scratch Contract",
                playerTurn: "'s Turn",
                
                // Table
                round: "Round",
                contract: "Contract",
                total: "TOTAL",
                
                // Winner
                itsATie: "It's a tie!",
                tiedWith: "tied with",
                points: "points",
                wins: "Wins!",
                finalScore: "Final Score:",
                editScores: "‚Üê Edit Scores",
                playAgain: "Play Again",
                
                // Rules
                gameRules: "üìã Game Rules",
                rulesClassic: "<strong>Classic:</strong> Hit the contract target to add your score to your capital. Miss it and your capital is halved!",
                rulesFreeChoice: "<strong>Yahtzee Style:</strong> Choose where to register your score each turn. Scratch contracts you can't fill (score 0).",
                
                // Alert
                selectContractAlert: "Please select a contract to fill or scratch.",
                invalidScore: "Invalid score for this contract!",
                invalidScoreDetail: "For {contract}, score must be {rule}.",

                // Dart Input
                enterDarts: "Enter Your Darts",
                dartsThrown: "Darts Thrown:",
                miss: "Miss",
                undo: "Undo",
                clear: "Clear",
                confirm: "Confirm",

                // Contracts
                contracts: {
                    capital: { name: "Capital", desc: "First 3 darts - establish your starting score" },
                    "20": { name: "20", desc: "Hit the 20 segment" },
                    side: { name: "Side", desc: "Hit 3 adjacent segments (e.g., 5-20-1). Bullseye touches all." },
                    "19": { name: "19", desc: "Hit the 19 segment" },
                    "3row": { name: "3 in a Row", desc: "Hit 3 consecutive numbers (e.g., 14-15-16)" },
                    "18": { name: "18", desc: "Hit the 18 segment" },
                    color: { name: "Color", desc: "Hit 3 different colors (black, white, green, red)" },
                    "17": { name: "17", desc: "Hit the 17 segment" },
                    double: { name: "Double", desc: "Hit any double" },
                    "16": { name: "16", desc: "Hit the 16 segment" },
                    triple: { name: "Triple", desc: "Hit any triple" },
                    "15": { name: "15", desc: "Hit the 15 segment" },
                    "57": { name: "57", desc: "Score exactly 57 with 3 darts" },
                    "14": { name: "14", desc: "Hit the 14 segment" },
                    bull: { name: "Bull", desc: "Hit the bullseye (single 25 or double 50)" }
                }
            },
            fr: {
                // Setup
                gameMode: "Mode de Jeu",
                classic: "Classique",
                freeChoice: "Yahtzee Style",
                classicDesc: "Jouez les contrats dans l'ordre. R√©ussissez pour ajouter le score, ratez pour diviser votre capital par deux.",
                freeChoiceDesc: "Choisissez o√π enregistrer votre score. Remplissez ou barrez les contrats librement.",
                addPlayers: "Ajouter des Joueurs",
                enterPlayerName: "Nom du joueur",
                addPlayer: "Ajouter",
                startGame: "Commencer",
                
                // Game
                enterScores: "Entrez les Scores du Tour",
                enterYourScore: "Entrez Votre Score",
                score: "Score :",
                currentCapital: "Capital actuel :",
                startingRound: "Tour de d√©part",
                previousRound: "‚Üê Tour Pr√©c√©dent",
                previousTurn: "‚Üê Tour Pr√©c√©dent",
                submitRound: "Valider",
                confirmChoice: "Confirmer",
                resetGame: "Recommencer",
                chooseContract: "Choisissez un contrat √† remplir ou barrer",
                selectContractFill: "S√©lectionnez un Contrat √† Remplir :",
                scratchContract: "Ou Barrez un Contrat (score 0) :",
                selectContract: "S√©lectionnez un Contrat :",
                fillMode: "Remplir Contrat",
                scratchMode: "Barrer Contrat",
                playerTurn: " - √Ä votre tour",
                
                // Table
                round: "Tour",
                contract: "Contrat",
                total: "TOTAL",
                
                // Winner
                itsATie: "√âgalit√© !",
                tiedWith: "√† √©galit√© avec",
                points: "points",
                wins: "Gagne !",
                finalScore: "Score Final :",
                editScores: "‚Üê Modifier",
                playAgain: "Rejouer",
                
                // Rules
                gameRules: "üìã R√®gles du Jeu",
                rulesClassic: "<strong>Classique :</strong> R√©ussissez le contrat pour ajouter votre score au capital. Ratez et votre capital est divis√© par deux !",
                rulesFreeChoice: "<strong>Yahtzee Style :</strong> Choisissez o√π enregistrer votre score √† chaque tour. Barrez les contrats impossibles (score 0).",
                
                // Alert
                selectContractAlert: "Veuillez s√©lectionner un contrat √† remplir ou barrer.",
                invalidScore: "Score invalide pour ce contrat !",
                invalidScoreDetail: "Pour {contract}, le score doit √™tre {rule}.",

                // Dart Input
                enterDarts: "Entrez Vos Fl√©chettes",
                dartsThrown: "Fl√©chettes Lanc√©es :",
                miss: "Rat√©",
                undo: "Annuler",
                clear: "Effacer",
                confirm: "Confirmer",

                // Contracts
                contracts: {
                    capital: { name: "Capital", desc: "3 premi√®res fl√©chettes - √©tablissez votre score de d√©part" },
                    "20": { name: "20", desc: "Touchez le segment 20" },
                    side: { name: "C√¥t√©", desc: "Touchez 3 segments adjacents (ex: 5-20-1). Le bull touche tous." },
                    "19": { name: "19", desc: "Touchez le segment 19" },
                    "3row": { name: "Suite", desc: "Touchez 3 num√©ros cons√©cutifs (ex: 14-15-16)" },
                    "18": { name: "18", desc: "Touchez le segment 18" },
                    color: { name: "Couleur", desc: "Touchez 3 couleurs diff√©rentes (noir, blanc, vert, rouge)" },
                    "17": { name: "17", desc: "Touchez le segment 17" },
                    double: { name: "Double", desc: "Touchez n'importe quel double" },
                    "16": { name: "16", desc: "Touchez le segment 16" },
                    triple: { name: "Triple", desc: "Touchez n'importe quel triple" },
                    "15": { name: "15", desc: "Touchez le segment 15" },
                    "57": { name: "57", desc: "Marquez exactement 57 avec 3 fl√©chettes" },
                    "14": { name: "14", desc: "Touchez le segment 14" },
                    bull: { name: "Bull", desc: "Touchez le centre (simple 25 ou double 50)" }
                }
            },
            es: {
                // Setup
                gameMode: "Modo de Juego",
                classic: "Cl√°sico",
                freeChoice: "Yahtzee Style",
                classicDesc: "Juega los contratos en orden. Acierta para sumar puntos, falla para dividir tu capital a la mitad.",
                freeChoiceDesc: "Elige d√≥nde registrar tu puntuaci√≥n. Completa o tacha contratos libremente.",
                addPlayers: "A√±adir Jugadores",
                enterPlayerName: "Nombre del jugador",
                addPlayer: "A√±adir",
                startGame: "Comenzar",
                
                // Game
                enterScores: "Introduce las Puntuaciones de la Ronda",
                enterYourScore: "Introduce Tu Puntuaci√≥n",
                score: "Puntos:",
                currentCapital: "Capital actual:",
                startingRound: "Ronda inicial",
                previousRound: "‚Üê Ronda Anterior",
                previousTurn: "‚Üê Turno Anterior",
                submitRound: "Enviar",
                confirmChoice: "Confirmar",
                resetGame: "Reiniciar",
                chooseContract: "Elige un contrato para completar o tachar",
                selectContractFill: "Selecciona un Contrato para Completar:",
                scratchContract: "O Tacha un Contrato (puntuaci√≥n 0):",
                selectContract: "Selecciona un Contrato:",
                fillMode: "Completar Contrato",
                scratchMode: "Tachar Contrato",
                playerTurn: " - Tu turno",
                
                // Table
                round: "Ronda",
                contract: "Contrato",
                total: "TOTAL",
                
                // Winner
                itsATie: "¬°Empate!",
                tiedWith: "empatados con",
                points: "puntos",
                wins: "¬°Gana!",
                finalScore: "Puntuaci√≥n Final:",
                editScores: "‚Üê Editar",
                playAgain: "Jugar de Nuevo",
                
                // Rules
                gameRules: "üìã Reglas del Juego",
                rulesClassic: "<strong>Cl√°sico:</strong> Acierta el contrato para sumar tu puntuaci√≥n al capital. ¬°Falla y tu capital se divide a la mitad!",
                rulesFreeChoice: "<strong>Yahtzee Style:</strong> Elige d√≥nde registrar tu puntuaci√≥n cada turno. Tacha los contratos que no puedas completar (puntuaci√≥n 0).",
                
                // Alert
                selectContractAlert: "Por favor, selecciona un contrato para completar o tachar.",
                invalidScore: "¬°Puntuaci√≥n inv√°lida para este contrato!",
                invalidScoreDetail: "Para {contract}, la puntuaci√≥n debe ser {rule}.",

                // Dart Input
                enterDarts: "Introduce Tus Dardos",
                dartsThrown: "Dardos Lanzados:",
                miss: "Fallo",
                undo: "Deshacer",
                clear: "Borrar",
                confirm: "Confirmar",

                // Contracts
                contracts: {
                    capital: { name: "Capital", desc: "3 primeros dardos - establece tu puntuaci√≥n inicial" },
                    "20": { name: "20", desc: "Acierta el segmento 20" },
                    side: { name: "Lado", desc: "Acierta 3 segmentos adyacentes (ej: 5-20-1). El bull toca todos." },
                    "19": { name: "19", desc: "Acierta el segmento 19" },
                    "3row": { name: "Escalera", desc: "Acierta 3 n√∫meros consecutivos (ej: 14-15-16)" },
                    "18": { name: "18", desc: "Acierta el segmento 18" },
                    color: { name: "Color", desc: "Acierta 3 colores diferentes (negro, blanco, verde, rojo)" },
                    "17": { name: "17", desc: "Acierta el segmento 17" },
                    double: { name: "Doble", desc: "Acierta cualquier doble" },
                    "16": { name: "16", desc: "Acierta el segmento 16" },
                    triple: { name: "Triple", desc: "Acierta cualquier triple" },
                    "15": { name: "15", desc: "Acierta el segmento 15" },
                    "57": { name: "57", desc: "Marca exactamente 57 con 3 dardos" },
                    "14": { name: "14", desc: "Acierta el segmento 14" },
                    bull: { name: "Bull", desc: "Acierta la diana (simple 25 o doble 50)" }
                }
            }
        };

        // Contract IDs in order
        const CONTRACT_IDS = ['capital', '20', 'side', '19', '3row', '18', 'color', '17', 'double', '16', 'triple', '15', '57', '14', 'bull'];

        // Current language
        let currentLang = 'en';

        // Game state
        let players = [];
        let gameMode = 'classic';
        let currentRound = 0;
        let currentPlayerIndex = 0;
        let scoresHidden = false;
        let selectedContract = null;
        let selectedScratch = null;
        let isScratchMode = false;
        let scores = {};
        let yahtzeeHistory = [];

        // Dart input state
        let dartInputTargetField = null;
        let currentDarts = [];
        let currentModifier = 'single';
        let storedDarts = {}; // Store darts for each player: { playerKey: [dart1, dart2, dart3] }

        // ==================== LOCAL STORAGE FUNCTIONS ====================

        const STORAGE_KEY = 'halveItGameState';

        function saveGameState() {
            const gameState = {
                // Setup state
                players: players,
                gameMode: gameMode,
                currentLang: currentLang,

                // Game state
                currentRound: currentRound,
                currentPlayerIndex: currentPlayerIndex,
                scores: scores,
                yahtzeeHistory: yahtzeeHistory,
                scoresHidden: scoresHidden,
                storedDarts: storedDarts,

                // UI state
                isGameStarted: document.getElementById('gameBoard').style.display !== 'none',
                isWinnerShown: document.getElementById('winnerSection').style.display === 'block',

                // Timestamp for debugging
                savedAt: new Date().toISOString()
            };

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
            } catch (e) {
                console.error('Failed to save game state:', e);
            }
        }

        function loadGameState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return false;

                const gameState = JSON.parse(saved);

                // Restore setup state
                players = gameState.players || [];
                gameMode = gameState.gameMode || 'classic';
                currentLang = gameState.currentLang || 'en';

                // Restore game state
                currentRound = gameState.currentRound || 0;
                currentPlayerIndex = gameState.currentPlayerIndex || 0;
                scores = gameState.scores || {};
                yahtzeeHistory = gameState.yahtzeeHistory || [];
                scoresHidden = gameState.scoresHidden || false;
                storedDarts = gameState.storedDarts || {};

                // Apply language (pass true to prevent saving during load)
                setLanguage(currentLang, true);

                // Restore UI state
                if (gameState.isGameStarted) {
                    // Hide setup, show game board
                    document.getElementById('setupSection').classList.add('hidden');
                    document.getElementById('gameBoard').style.display = 'block';

                    if (gameMode === 'classic') {
                        document.getElementById('classicRoundDisplay').classList.remove('hidden');
                        document.getElementById('classicInputSection').classList.remove('hidden');
                        document.getElementById('yahtzeePlayerDisplay').classList.add('hidden');
                        document.getElementById('yahtzeeInputSection').classList.add('hidden');
                        document.getElementById('hideScoresBtn').classList.add('hidden');

                        buildClassicTable();
                        updateRoundDisplay();
                        buildScoreInputs();
                        updatePrevButton();

                        // Restore scores in the table
                        players.forEach(player => {
                            const playerKey = player.replace(/\s/g, '_');
                            const playerData = scores[player];

                            if (playerData && playerData.rounds) {
                                playerData.rounds.forEach((round, i) => {
                                    const cell = document.getElementById(`cell-${playerKey}-${i}`);
                                    if (cell) {
                                        if (i === 0) {
                                            cell.textContent = round.score;
                                            cell.className = 'score-success';
                                        } else {
                                            if (round.success) {
                                                cell.textContent = `+${round.score}`;
                                                cell.className = 'score-success';
                                            } else {
                                                cell.textContent = `√∑2`;
                                                cell.className = 'score-fail';
                                            }
                                        }
                                    }
                                });

                                document.getElementById(`total-${playerKey}`).textContent = playerData.capital;
                            }
                        });

                        if (gameState.isWinnerShown) {
                            document.getElementById('classicInputSection').classList.add('hidden');
                            showWinner();
                        }
                    } else {
                        document.getElementById('classicRoundDisplay').classList.add('hidden');
                        document.getElementById('classicInputSection').classList.add('hidden');
                        document.getElementById('yahtzeePlayerDisplay').classList.remove('hidden');
                        document.getElementById('yahtzeeInputSection').classList.remove('hidden');
                        document.getElementById('hideScoresBtn').classList.remove('hidden');

                        buildYahtzeeTable();

                        // Update display without clearing darts (since we just restored them)
                        const currentPlayer = players[currentPlayerIndex];
                        document.getElementById('currentPlayerName').textContent = `${currentPlayer}${t('playerTurn')}`;
                        selectedContract = null;
                        selectedScratch = null;
                        isScratchMode = false;

                        // Reset toggle buttons
                        document.getElementById('fillModeBtn').classList.add('active');
                        document.getElementById('fillModeBtn').classList.remove('scratch-active');
                        document.getElementById('scratchModeBtn').classList.remove('scratch-active');
                        document.getElementById('scratchModeBtn').classList.remove('active');

                        buildContractSelectors();
                        updateYahtzeePrevButton();
                        updateYahtzeeDartsDisplay();

                        // Restore scores in the table
                        players.forEach(player => {
                            const playerKey = player.replace(/\s/g, '_');
                            const playerData = scores[player];

                            if (playerData && playerData.contracts) {
                                CONTRACT_IDS.forEach(id => {
                                    const contractData = playerData.contracts[id];
                                    const cell = document.getElementById(`ycell-${playerKey}-${id}`);

                                    if (cell && contractData) {
                                        if (contractData.scratched) {
                                            cell.textContent = '‚úó';
                                            cell.className = 'score-cell cell-scratched';
                                        } else if (contractData.score !== null) {
                                            cell.textContent = contractData.score;
                                            cell.className = 'score-cell cell-filled';
                                        }
                                    }
                                });

                                const totalCell = document.getElementById(`ytotal-${playerKey}`);
                                if (totalCell) {
                                    totalCell.textContent = scoresHidden ? '???' : playerData.total;
                                }
                            }
                        });

                        updateScoreVisibility();

                        if (gameState.isWinnerShown) {
                            document.getElementById('yahtzeeInputSection').classList.add('hidden');
                            showWinner();
                        }
                    }
                } else {
                    // Still in setup phase
                    // Restore game mode selection
                    const modeRadio = document.querySelector(`input[name="gameMode"][value="${gameMode}"]`);
                    if (modeRadio) {
                        modeRadio.checked = true;
                    }
                    updatePlayerList();
                }

                return true;
            } catch (e) {
                console.error('Failed to load game state:', e);
                return false;
            }
        }

        function clearGameState() {
            try {
                localStorage.removeItem(STORAGE_KEY);
            } catch (e) {
                console.error('Failed to clear game state:', e);
            }
        }

        // ==================== LANGUAGE FUNCTIONS ====================

        function setLanguage(lang, fromLoad = false) {
            currentLang = lang;

            // Update language button states
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.onclick && btn.onclick.toString().includes(`'${lang}'`)) {
                    btn.classList.add('active');
                }
            });

            applyTranslations();
            buildRulesGrid();
            updateModeDescription();

            if (!fromLoad) {
                saveGameState();
            }
        }

        function t(key) {
            return translations[currentLang][key] || translations['en'][key] || key;
        }

        function getContractName(id) {
            return translations[currentLang].contracts[id]?.name || id;
        }

        function getContractDesc(id) {
            return translations[currentLang].contracts[id]?.desc || '';
        }

        function applyTranslations() {
            // Apply text translations
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    if (key === 'rulesClassic' || key === 'rulesFreeChoice') {
                        el.innerHTML = translations[currentLang][key];
                    } else {
                        el.textContent = translations[currentLang][key];
                    }
                }
            });
            
            // Apply placeholder translations
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[currentLang][key]) {
                    el.placeholder = translations[currentLang][key];
                }
            });
        }

        function buildRulesGrid() {
            const grid = document.getElementById('rulesGrid');
            grid.innerHTML = CONTRACT_IDS.map(id => `
                <div class="rule-item"><strong>${getContractName(id)}:</strong> ${getContractDesc(id)}</div>
            `).join('');
        }

        // ==================== SETUP FUNCTIONS ====================

        function updateModeDescription() {
            const mode = document.querySelector('input[name="gameMode"]:checked').value;
            const desc = document.getElementById('modeDescription');
            desc.textContent = mode === 'classic' ? t('classicDesc') : t('freeChoiceDesc');
        }

        function addPlayer() {
            const input = document.getElementById('playerNameInput');
            const name = input.value.trim();

            if (name && !players.includes(name)) {
                players.push(name);
                updatePlayerList();
                input.value = '';
                saveGameState();
            }
            input.focus();
        }

        function removePlayer(name) {
            players = players.filter(p => p !== name);
            updatePlayerList();
            saveGameState();
        }

        function updatePlayerList() {
            const list = document.getElementById('playerList');
            list.innerHTML = players.map(p => `
                <div class="player-tag">
                    ${p}
                    <button onclick="removePlayer('${p}')" class="btn-small">√ó</button>
                </div>
            `).join('');
            
            document.getElementById('startBtn').style.display = players.length >= 1 ? 'block' : 'none';
        }

        function startGame() {
            gameMode = document.querySelector('input[name="gameMode"]:checked').value;
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('gameBoard').style.display = 'block';
            currentRound = 0;
            currentPlayerIndex = 0;
            storedDarts = {};

            if (gameMode === 'classic') {
                players.forEach(p => {
                    scores[p] = { capital: 0, rounds: [] };
                });
                document.getElementById('classicRoundDisplay').classList.remove('hidden');
                document.getElementById('classicInputSection').classList.remove('hidden');
                document.getElementById('yahtzeePlayerDisplay').classList.add('hidden');
                document.getElementById('yahtzeeInputSection').classList.add('hidden');
                document.getElementById('hideScoresBtn').classList.add('hidden');
                buildClassicTable();
                updateRoundDisplay();
                buildScoreInputs();
                updatePrevButton();
            } else {
                yahtzeeHistory = [];
                players.forEach(p => {
                    scores[p] = {
                        contracts: {},
                        total: 0
                    };
                    CONTRACT_IDS.forEach(id => {
                        scores[p].contracts[id] = { score: null, scratched: false };
                    });
                });
                document.getElementById('classicRoundDisplay').classList.add('hidden');
                document.getElementById('classicInputSection').classList.add('hidden');
                document.getElementById('yahtzeePlayerDisplay').classList.remove('hidden');
                document.getElementById('yahtzeeInputSection').classList.remove('hidden');
                document.getElementById('hideScoresBtn').classList.remove('hidden');
                buildYahtzeeTable();
                updateYahtzeeDisplay();
                updateYahtzeePrevButton();
            }
            saveGameState();
        }

        // ==================== CLASSIC MODE ====================
        
        function buildClassicTable() {
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            
            let headerHTML = `<tr><th>${t('round')}</th>`;
            players.forEach(player => {
                headerHTML += `<th>${player}</th>`;
            });
            headerHTML += '</tr>';
            head.innerHTML = headerHTML;
            
            let bodyHTML = '';
            CONTRACT_IDS.forEach((id, i) => {
                bodyHTML += `<tr id="row-${i}" class="${i === currentRound ? 'round-current' : ''}">
                    <td class="round-name-cell">${getContractName(id)}</td>`;
                players.forEach(player => {
                    const playerKey = player.replace(/\s/g, '_');
                    bodyHTML += `<td id="cell-${playerKey}-${i}">-</td>`;
                });
                bodyHTML += '</tr>';
            });
            
            bodyHTML += `<tr class="total-row"><td class="round-name-cell">${t('total')}</td>`;
            players.forEach(player => {
                const playerKey = player.replace(/\s/g, '_');
                bodyHTML += `<td id="total-${playerKey}">0</td>`;
            });
            bodyHTML += '</tr>';
            
            body.innerHTML = bodyHTML;
        }

        function updateRoundDisplay() {
            const contractId = CONTRACT_IDS[currentRound];
            document.getElementById('currentRoundName').textContent = getContractName(contractId);
            document.getElementById('currentRoundDesc').textContent = getContractDesc(contractId);
            
            CONTRACT_IDS.forEach((id, i) => {
                const row = document.getElementById(`row-${i}`);
                if (row) {
                    row.classList.toggle('round-current', i === currentRound);
                }
            });
        }

        function buildScoreInputs() {
            const container = document.getElementById('scoreInputs');

            container.innerHTML = players.map(player => {
                const playerData = scores[player];
                const capitalDisplay = currentRound === 0 ? t('startingRound') : `${t('currentCapital')} ${playerData.capital}`;
                const inputId = `score-${player.replace(/\s/g, '_')}`;

                // Check if player has entered darts
                const playerDarts = storedDarts[inputId];
                let dartsDisplay = '';
                if (playerDarts && playerDarts.length > 0) {
                    dartsDisplay = playerDarts.map(d => d.displayText).join(', ');
                } else {
                    dartsDisplay = '<span style="color: #636e72;">No darts entered</span>';
                }

                return `
                    <div class="player-score-card">
                        <h4>${player}</h4>
                        <div class="current-capital">${capitalDisplay}</div>
                        <div class="score-row" style="flex-direction: column; align-items: stretch;">
                            <div style="margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px; text-align: center;">
                                ${dartsDisplay}
                            </div>
                            <button class="dart-input-btn" onclick="openDartInputClassic('${inputId}')" title="Enter darts" style="width: 100%;">üéØ ${t('enterDarts')}</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editLastRound() {
            document.getElementById('winnerSection').style.display = 'none';
            
            if (gameMode === 'classic') {
                document.getElementById('classicInputSection').classList.remove('hidden');
                previousRound();
            } else {
                document.getElementById('yahtzeeInputSection').classList.remove('hidden');
                previousYahtzeeTurn();
            }
        }

        function previousRound() {
            if (currentRound === 0) return;

            currentRound--;

            players.forEach(player => {
                const playerKey = player.replace(/\s/g, '_');
                const lastRound = scores[player].rounds.pop();

                // Restore darts from the last round
                const inputId = `score-${playerKey}`;
                if (lastRound && lastRound.darts) {
                    storedDarts[inputId] = [...lastRound.darts];
                }

                if (scores[player].rounds.length > 0) {
                    scores[player].capital = scores[player].rounds[scores[player].rounds.length - 1].capitalAfter;
                } else {
                    scores[player].capital = 0;
                }

                const cell = document.getElementById(`cell-${playerKey}-${currentRound}`);
                cell.textContent = '-';
                cell.className = '';

                document.getElementById(`total-${playerKey}`).textContent = scores[player].capital;
            });

            updateRoundDisplay();
            buildScoreInputs();
            updatePrevButton();
            saveGameState();
        }

        function updatePrevButton() {
            document.getElementById('prevBtn').style.display = currentRound > 0 ? 'inline-block' : 'none';
        }

        function submitRound() {
            const contractId = CONTRACT_IDS[currentRound];

            // Check if all players have entered darts
            for (let player of players) {
                const playerKey = player.replace(/\s/g, '_');
                const inputId = `score-${playerKey}`;
                const playerDarts = storedDarts[inputId];

                if (!playerDarts || playerDarts.length === 0) {
                    alert(`${player} has not entered darts yet!`);
                    return;
                }
            }

            // Calculate scores from darts
            players.forEach(player => {
                const playerKey = player.replace(/\s/g, '_');
                const inputId = `score-${playerKey}`;
                const playerDarts = storedDarts[inputId];

                let score;
                if (currentRound === 0) {
                    // Capital: Use total score from darts
                    score = playerDarts.reduce((sum, d) => sum + d.score, 0);
                } else {
                    // Check if darts meet contract requirements
                    const meetsRequirements = checkContractRequirements(playerDarts, contractId);

                    if (!meetsRequirements) {
                        // If requirements not met, score is 0 (capital will be halved)
                        score = 0;
                    } else {
                        // Requirements met, calculate score
                        const targetNumber = parseInt(contractId);
                        if (isNaN(targetNumber)) {
                            // For non-numeric contracts (side, 3row, color, double, triple, 57, bull)
                            // Use total score
                            score = playerDarts.reduce((sum, d) => sum + d.score, 0);
                        } else {
                            // For numeric contracts (20, 19, 18, 17, 16, 15, 14)
                            score = calculateClassicScore(playerDarts, targetNumber);
                        }
                    }
                }

                // Validate score
                if (!validateScore(score, contractId)) {
                    showValidationError(contractId);
                    return;
                }

                if (currentRound === 0) {
                    scores[player].capital = score;
                    scores[player].rounds.push({
                        score: score,
                        success: true,
                        capitalAfter: score,
                        darts: [...playerDarts]
                    });

                    const cell = document.getElementById(`cell-${playerKey}-${currentRound}`);
                    cell.textContent = score;
                    cell.className = 'score-success';
                } else {
                    const success = score > 0;
                    let newCapital;

                    if (success) {
                        newCapital = scores[player].capital + score;
                    } else {
                        newCapital = Math.ceil(scores[player].capital / 2);
                    }

                    scores[player].rounds.push({
                        score: score,
                        success: success,
                        capitalAfter: newCapital,
                        darts: [...playerDarts]
                    });

                    const cell = document.getElementById(`cell-${playerKey}-${currentRound}`);
                    if (success) {
                        cell.textContent = `+${score}`;
                        cell.className = 'score-success';
                    } else {
                        cell.textContent = `√∑2`;
                        cell.className = 'score-fail';
                    }

                    scores[player].capital = newCapital;
                }

                document.getElementById(`total-${playerKey}`).textContent = scores[player].capital;
            });

            // Clear stored darts for next round
            players.forEach(player => {
                const playerKey = player.replace(/\s/g, '_');
                const inputId = `score-${playerKey}`;
                delete storedDarts[inputId];
            });

            currentRound++;

            if (currentRound >= CONTRACT_IDS.length) {
                showWinner();
            } else {
                updateRoundDisplay();
                buildScoreInputs();
                updatePrevButton();
            }
            saveGameState();
        }

        // ==================== YAHTZEE MODE ====================

        function buildYahtzeeTable() {
            const head = document.getElementById('tableHead');
            const body = document.getElementById('tableBody');
            
            let headerHTML = `<tr><th>${t('contract')}</th>`;
            players.forEach(player => {
                headerHTML += `<th>${player}</th>`;
            });
            headerHTML += '</tr>';
            head.innerHTML = headerHTML;
            
            let bodyHTML = '';
            CONTRACT_IDS.forEach((id) => {
                bodyHTML += `<tr id="yrow-${id}">
                    <td class="round-name-cell">${getContractName(id)}</td>`;
                players.forEach(player => {
                    const playerKey = player.replace(/\s/g, '_');
                    bodyHTML += `<td id="ycell-${playerKey}-${id}" class="score-cell">-</td>`;
                });
                bodyHTML += '</tr>';
            });
            
            bodyHTML += `<tr class="total-row"><td class="round-name-cell">${t('total')}</td>`;
            players.forEach(player => {
                const playerKey = player.replace(/\s/g, '_');
                bodyHTML += `<td id="ytotal-${playerKey}">0</td>`;
            });
            bodyHTML += '</tr>';
            
            body.innerHTML = bodyHTML;
        }

        function updateYahtzeeDisplay() {
            const currentPlayer = players[currentPlayerIndex];
            document.getElementById('currentPlayerName').textContent = `${currentPlayer}${t('playerTurn')}`;
            selectedContract = null;
            selectedScratch = null;
            isScratchMode = false;

            // Clear darts for new player
            delete storedDarts['yahtzeeCurrentDarts'];
            updateYahtzeeDartsDisplay();

            // Reset toggle buttons
            document.getElementById('fillModeBtn').classList.add('active');
            document.getElementById('fillModeBtn').classList.remove('scratch-active');
            document.getElementById('scratchModeBtn').classList.remove('scratch-active');
            document.getElementById('scratchModeBtn').classList.remove('active');

            buildContractSelectors();
            updateYahtzeePrevButton();
        }

        function toggleScratchMode(scratchMode) {
            isScratchMode = scratchMode;

            // Update toggle buttons
            const fillBtn = document.getElementById('fillModeBtn');
            const scratchBtn = document.getElementById('scratchModeBtn');

            if (isScratchMode) {
                fillBtn.classList.remove('active');
                scratchBtn.classList.add('scratch-active');
                scratchBtn.classList.add('active');
            } else {
                fillBtn.classList.add('active');
                scratchBtn.classList.remove('scratch-active');
                scratchBtn.classList.remove('active');
            }

            // Clear selection
            selectedContract = null;
            selectedScratch = null;

            // Update contract buttons visual feedback
            buildContractSelectors();
        }

        function buildContractSelectors() {
            const currentPlayer = players[currentPlayerIndex];
            const playerContracts = scores[currentPlayer].contracts;

            const contractSelector = document.getElementById('contractSelector');

            // Get valid contracts based on entered darts
            const darts = storedDarts['yahtzeeCurrentDarts'];
            const validContracts = darts ? getValidContracts(darts) : [];

            let html = '';

            CONTRACT_IDS.forEach(id => {
                const contractData = playerContracts[id];
                const isUsed = contractData.score !== null || contractData.scratched;
                const name = getContractName(id);
                const isValid = validContracts.includes(id);

                if (isUsed) {
                    const status = contractData.scratched ? '‚úó' : `${contractData.score}`;
                    html += `<button class="contract-btn" disabled>${name}<br><small>${status}</small></button>`;
                } else {
                    // Apply scratch-mode class if in scratch mode
                    let classes = 'contract-btn';
                    if (isScratchMode) {
                        classes += ' scratch-mode';
                    }
                    // Check if this contract is currently selected
                    const isSelected = (selectedContract === id) || (selectedScratch === id);
                    if (isSelected) {
                        classes += ' selected';
                    }
                    // Build inline style for highlighting
                    let style = '';
                    if (isSelected) {
                        // Selected: blue border and background
                        style = ' style="border-color: #3282b8; border-width: 3px; background: #3282b8;"';
                    } else if (isValid && darts) {
                        // Valid but not selected: green border
                        style = ' style="border-color: #00b894; border-width: 3px; background: rgba(0, 184, 148, 0.2);"';
                    }
                    html += `<button class="${classes}" id="contract-${id}" onclick="selectContractUnified('${id}')"${style}>${name}${isValid && darts ? ' ‚úì' : ''}</button>`;
                }
            });

            contractSelector.innerHTML = html;
        }

        function selectContractUnified(contractId) {
            if (isScratchMode) {
                selectedContract = null;
                selectedScratch = contractId;
            } else {
                selectedScratch = null;
                selectedContract = contractId;
            }

            // Rebuild contract selectors to show the selection with proper styling
            buildContractSelectors();
        }

        function submitYahtzeeChoice() {
            const currentPlayer = players[currentPlayerIndex];
            const playerKey = currentPlayer.replace(/\s/g, '_');

            if (!selectedContract && !selectedScratch) {
                alert(t('selectContractAlert'));
                return;
            }

            // Check if darts have been entered (only required for fill mode)
            const darts = storedDarts['yahtzeeCurrentDarts'];
            if (selectedContract && (!darts || darts.length === 0)) {
                alert('Please enter your darts first!');
                return;
            }

            // Validate that the selected contract is valid for the entered darts
            if (selectedContract) {
                const validContracts = getValidContracts(darts);
                if (!validContracts.includes(selectedContract)) {
                    const contractName = getContractName(selectedContract);
                    alert(`The selected contract "${contractName}" is not valid for your darts. Please select a valid contract (highlighted in green with ‚úì).`);
                    return;
                }
            }

            // Calculate score from darts
            let score = 0;
            if (selectedContract) {
                score = calculateContractScore(darts, selectedContract);
            }

            yahtzeeHistory.push({
                playerIndex: currentPlayerIndex,
                player: currentPlayer,
                contractId: selectedContract || selectedScratch,
                wasScratched: !!selectedScratch,
                score: selectedContract ? score : 0,
                darts: darts ? [...darts] : []
            });

            if (selectedContract) {
                scores[currentPlayer].contracts[selectedContract].score = score;
                scores[currentPlayer].total += score;

                const cell = document.getElementById(`ycell-${playerKey}-${selectedContract}`);
                cell.textContent = score;
                cell.className = 'score-cell cell-filled';
            } else {
                scores[currentPlayer].contracts[selectedScratch].scratched = true;

                const cell = document.getElementById(`ycell-${playerKey}-${selectedScratch}`);
                cell.textContent = '‚úó';
                cell.className = 'score-cell cell-scratched';
            }

            const totalCell = document.getElementById(`ytotal-${playerKey}`);
            if (scoresHidden) {
                totalCell.textContent = '???';
            } else {
                totalCell.textContent = scores[currentPlayer].total;
            }

            updateScoreVisibility();
            updateYahtzeePrevButton();
            moveToNextPlayer();
            saveGameState();
        }

        function moveToNextPlayer() {
            let nextPlayerIndex = (currentPlayerIndex + 1) % players.length;
            let checkedPlayers = 0;
            
            while (checkedPlayers < players.length) {
                const player = players[nextPlayerIndex];
                const hasAvailable = CONTRACT_IDS.some(id => {
                    const data = scores[player].contracts[id];
                    return data.score === null && !data.scratched;
                });
                
                if (hasAvailable) {
                    currentPlayerIndex = nextPlayerIndex;
                    updateYahtzeeDisplay();
                    return;
                }
                
                nextPlayerIndex = (nextPlayerIndex + 1) % players.length;
                checkedPlayers++;
            }
            
            showWinner();
        }

        function updateYahtzeePrevButton() {
            document.getElementById('yahtzeePrevBtn').style.display = yahtzeeHistory.length > 0 ? 'inline-block' : 'none';
        }

        function previousYahtzeeTurn() {
            if (yahtzeeHistory.length === 0) return;

            const lastMove = yahtzeeHistory.pop();
            const player = lastMove.player;
            const playerKey = player.replace(/\s/g, '_');
            const contractId = lastMove.contractId;

            if (lastMove.wasScratched) {
                scores[player].contracts[contractId].scratched = false;
            } else {
                scores[player].contracts[contractId].score = null;
                scores[player].total -= lastMove.score;
            }

            const cell = document.getElementById(`ycell-${playerKey}-${contractId}`);
            cell.textContent = '-';
            cell.className = 'score-cell';
            cell.classList.remove('score-hidden');

            const totalCell = document.getElementById(`ytotal-${playerKey}`);
            if (scoresHidden) {
                totalCell.textContent = '???';
            } else {
                totalCell.textContent = scores[player].total;
            }

            currentPlayerIndex = lastMove.playerIndex;

            // Restore darts from the last move
            if (lastMove.darts && lastMove.darts.length > 0) {
                storedDarts['yahtzeeCurrentDarts'] = [...lastMove.darts];
                updateYahtzeeDartsDisplay();
            } else {
                delete storedDarts['yahtzeeCurrentDarts'];
                updateYahtzeeDartsDisplay();
            }

            // Update display
            selectedContract = null;
            selectedScratch = null;
            isScratchMode = false;

            // Reset toggle buttons
            document.getElementById('fillModeBtn').classList.add('active');
            document.getElementById('fillModeBtn').classList.remove('scratch-active');
            document.getElementById('scratchModeBtn').classList.remove('scratch-active');
            document.getElementById('scratchModeBtn').classList.remove('active');

            document.getElementById('currentPlayerName').textContent = `${player}${t('playerTurn')}`;
            buildContractSelectors();
            updateYahtzeePrevButton();
            saveGameState();
        }

        function toggleScoreVisibility() {
            scoresHidden = !scoresHidden;
            document.getElementById('hideScoresBtn').textContent = scoresHidden ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è';
            updateScoreVisibility();
            saveGameState();
        }

        function updateScoreVisibility() {
            if (gameMode !== 'yahtzee') return;
            
            players.forEach(player => {
                const playerKey = player.replace(/\s/g, '_');
                
                CONTRACT_IDS.forEach(id => {
                    const cell = document.getElementById(`ycell-${playerKey}-${id}`);
                    if (cell) {
                        const data = scores[player].contracts[id];
                        if (data.score !== null || data.scratched) {
                            cell.classList.toggle('score-hidden', scoresHidden);
                        }
                    }
                });
                
                const totalCell = document.getElementById(`ytotal-${playerKey}`);
                if (totalCell) {
                    if (scoresHidden) {
                        totalCell.textContent = '???';
                        totalCell.classList.add('score-hidden');
                    } else {
                        totalCell.textContent = scores[player].total;
                        totalCell.classList.remove('score-hidden');
                    }
                }
            });
        }

        // ==================== COMMON ====================

        function showWinner() {
            if (gameMode === 'classic') {
                document.getElementById('classicInputSection').classList.add('hidden');
                document.getElementById('editScoresBtn').style.display = 'inline-block';
            } else {
                document.getElementById('yahtzeeInputSection').classList.add('hidden');
                document.getElementById('editScoresBtn').style.display = yahtzeeHistory.length > 0 ? 'inline-block' : 'none';
                scoresHidden = false;
                document.getElementById('hideScoresBtn').textContent = 'üëÅÔ∏è';
                updateScoreVisibility();
            }
            
            let highScore = -Infinity;
            
            players.forEach(player => {
                const playerScore = gameMode === 'classic' ? scores[player].capital : scores[player].total;
                if (playerScore > highScore) {
                    highScore = playerScore;
                }
            });
            
            const winners = players.filter(p => {
                const s = gameMode === 'classic' ? scores[p].capital : scores[p].total;
                return s === highScore;
            });
            
            const winnerSection = document.getElementById('winnerSection');
            winnerSection.style.display = 'block';
            
            if (winners.length > 1) {
                document.getElementById('winnerName').textContent = t('itsATie');
                document.getElementById('winnerScore').textContent = `${winners.join(' & ')} ${t('tiedWith')} ${highScore} ${t('points')}!`;
            } else {
                document.getElementById('winnerName').textContent = `üéâ ${winners[0]} ${t('wins')} üéâ`;
                document.getElementById('winnerScore').textContent = `${t('finalScore')} ${highScore} ${t('points')}`;
            }
        }

        function resetGame() {
            const confirmMessage = {
                'en': 'Are you sure you want to reset the game? All progress will be lost.',
                'fr': '√ätes-vous s√ªr de vouloir recommencer ? Toute la progression sera perdue.',
                'es': '¬øEst√°s seguro de que quieres reiniciar el juego? Se perder√° todo el progreso.'
            };

            if (!confirm(confirmMessage[currentLang])) {
                return;
            }

            currentRound = 0;
            currentPlayerIndex = 0;
            scores = {};
            scoresHidden = false;
            selectedContract = null;
            selectedScratch = null;
            isScratchMode = false;
            yahtzeeHistory = [];
            storedDarts = {};

            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('winnerSection').style.display = 'none';
            document.getElementById('classicInputSection').classList.remove('hidden');
            document.getElementById('yahtzeeInputSection').classList.add('hidden');
            document.getElementById('hideScoresBtn').classList.add('hidden');

            updatePlayerList();
            clearGameState();
        }

        // ==================== DART INPUT ====================

        function openDartInput(inputFieldId) {
            dartInputTargetField = inputFieldId;
            currentDarts = [];
            currentModifier = 'single';
            updateDartDisplay();
            setModifier('single');
            document.getElementById('dartInputModal').classList.add('active');
        }

        function openDartInputClassic(inputFieldId) {
            dartInputTargetField = inputFieldId;
            // Load existing darts if any
            currentDarts = storedDarts[inputFieldId] ? [...storedDarts[inputFieldId]] : [];
            currentModifier = 'single';
            updateDartDisplay();
            setModifier('single');
            document.getElementById('dartInputModal').classList.add('active');
        }

        function openDartInputYahtzee() {
            dartInputTargetField = 'yahtzeeCurrentDarts';
            // Load existing darts if any
            currentDarts = storedDarts['yahtzeeCurrentDarts'] ? [...storedDarts['yahtzeeCurrentDarts']] : [];
            currentModifier = 'single';
            updateDartDisplay();
            setModifier('single');
            document.getElementById('dartInputModal').classList.add('active');
        }

        function closeDartInput() {
            document.getElementById('dartInputModal').classList.remove('active');
            dartInputTargetField = null;
        }

        function setModifier(modifier) {
            currentModifier = modifier;
            document.getElementById('singleBtn').classList.remove('active');
            document.getElementById('doubleBtn').classList.remove('active');
            document.getElementById('tripleBtn').classList.remove('active');
            document.getElementById(modifier + 'Btn').classList.add('active');
        }

        function addDart(number) {
            if (currentDarts.length >= 3) return;

            let score = number;
            let displayText = '';
            let modifier = currentModifier;

            if (number === 25) {
                // Bullseye: single=25, double=50
                if (currentModifier === 'double') {
                    score = 50;
                    displayText = 'Bull√ó2';
                } else {
                    score = 25;
                    displayText = 'Bull';
                    modifier = 'single';
                }
            } else if (number === 0) {
                score = 0;
                displayText = 'Miss';
                modifier = 'miss';
            } else {
                if (currentModifier === 'double') {
                    score = number * 2;
                    displayText = `D${number}`;
                } else if (currentModifier === 'triple') {
                    score = number * 3;
                    displayText = `T${number}`;
                } else {
                    score = number;
                    displayText = `${number}`;
                }
            }

            currentDarts.push({ number, modifier, score, displayText });
            updateDartDisplay();

            // Reset to single after each dart
            setModifier('single');
        }

        function clearLastDart() {
            if (currentDarts.length > 0) {
                currentDarts.pop();
                updateDartDisplay();
            }
        }

        function clearAllDarts() {
            currentDarts = [];
            updateDartDisplay();
        }

        function updateDartDisplay() {
            const dart1 = document.getElementById('dart1Display');
            const dart2 = document.getElementById('dart2Display');
            const dart3 = document.getElementById('dart3Display');
            const totalDisplay = document.getElementById('dartTotalDisplay');

            // Update dart 1
            if (currentDarts.length >= 1) {
                dart1.textContent = currentDarts[0].displayText;
                dart1.classList.remove('empty');
            } else {
                dart1.textContent = '-';
                dart1.classList.add('empty');
            }

            // Update dart 2
            if (currentDarts.length >= 2) {
                dart2.textContent = currentDarts[1].displayText;
                dart2.classList.remove('empty');
            } else {
                dart2.textContent = '-';
                dart2.classList.add('empty');
            }

            // Update dart 3
            if (currentDarts.length >= 3) {
                dart3.textContent = currentDarts[2].displayText;
                dart3.classList.remove('empty');
            } else {
                dart3.textContent = '-';
                dart3.classList.add('empty');
            }

            // Calculate and update total
            const total = currentDarts.reduce((sum, dart) => sum + dart.score, 0);
            totalDisplay.textContent = total;
        }

        function confirmDarts() {
            const total = currentDarts.reduce((sum, dart) => sum + dart.score, 0);
            if (dartInputTargetField) {
                // Store the darts for this input field
                storedDarts[dartInputTargetField] = [...currentDarts];

                // Update the input value if it exists
                const inputField = document.getElementById(dartInputTargetField);
                if (inputField) {
                    inputField.value = total;
                }

                // Rebuild score inputs if in Classic mode
                if (gameMode === 'classic' && document.getElementById('classicInputSection').classList.contains('hidden') === false) {
                    buildScoreInputs();
                }

                // Update Yahtzee darts display and highlight valid contracts
                if (gameMode === 'yahtzee' && dartInputTargetField === 'yahtzeeCurrentDarts') {
                    updateYahtzeeDartsDisplay();
                    buildContractSelectors();
                }
            }
            closeDartInput();
        }

        function updateYahtzeeDartsDisplay() {
            const display = document.getElementById('yahtzeeDartsDisplay');
            const darts = storedDarts['yahtzeeCurrentDarts'];

            if (darts && darts.length > 0) {
                const dartsText = darts.map(d => d.displayText).join(', ');
                const total = darts.reduce((sum, d) => sum + d.score, 0);
                display.innerHTML = `<div style="color: #00b894; font-weight: bold;">${dartsText}</div><div style="color: #f9d423; margin-top: 5px;">Total: ${total}</div>`;
            } else {
                display.innerHTML = '<span style="color: #636e72;">No darts entered</span>';
            }
        }

        // ==================== DART ANALYSIS ====================

        // For Classic mode: Calculate score for hitting a specific number
        function calculateClassicScore(darts, targetNumber) {
            if (!darts || darts.length === 0) return 0;

            let score = 0;
            for (let dart of darts) {
                if (dart.number === targetNumber) {
                    score += dart.score;
                }
            }
            return score;
        }

        // Dartboard color map (standard dartboard)
        const DART_COLORS = {
            20: 'black', 1: 'white', 18: 'black', 4: 'white', 13: 'black', 6: 'white',
            10: 'black', 15: 'white', 2: 'black', 17: 'white', 3: 'black', 19: 'white',
            7: 'black', 16: 'white', 8: 'black', 11: 'white', 14: 'black', 9: 'white',
            12: 'black', 5: 'white', 25: 'green', 50: 'red'
        };

        // Get the color of a dart (bull is green for 25, red for 50)
        function getDartColor(dart) {
            if (dart.number === 25) {
                return dart.modifier === 'double' ? 'red' : 'green';
            }
            return DART_COLORS[dart.number] || null;
        }

        // Dartboard arrangement (clockwise from top)
        const DARTBOARD_SEQUENCE = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];

        // Check if 3 numbers are adjacent on the dartboard
        function areAdjacent(dart1, dart2, dart3) {
            // Only single bull (not double bull) is adjacent to everything
            const isSingleBull = (dart) => dart.number === 25 && dart.modifier === 'single';

            if (isSingleBull(dart1) || isSingleBull(dart2) || isSingleBull(dart3)) return true;

            const nums = [dart1.number, dart2.number, dart3.number].filter(n => n !== 0 && n !== 25);
            if (nums.length < 3) return false;

            for (let i = 0; i < DARTBOARD_SEQUENCE.length; i++) {
                const current = DARTBOARD_SEQUENCE[i];
                const next1 = DARTBOARD_SEQUENCE[(i + 1) % DARTBOARD_SEQUENCE.length];
                const next2 = DARTBOARD_SEQUENCE[(i + 2) % DARTBOARD_SEQUENCE.length];

                if (nums.includes(current) && nums.includes(next1) && nums.includes(next2)) {
                    return true;
                }
            }
            return false;
        }

        // Check if 3 numbers are consecutive (e.g., 14-15-16)
        function areConsecutive(num1, num2, num3) {
            const nums = [num1, num2, num3].filter(n => n !== 0 && n !== 25).sort((a, b) => a - b);
            if (nums.length < 3) return false;
            return nums[1] === nums[0] + 1 && nums[2] === nums[1] + 1;
        }

        // For Yahtzee mode: Determine which contracts are valid for given darts
        function getValidContracts(darts) {
            if (!darts || darts.length === 0) return [];

            const validContracts = [];
            const numbers = darts.map(d => d.number);
            const modifiers = darts.map(d => d.modifier);

            // Capital: Always valid
            validContracts.push('capital');

            // Number contracts (20, 19, 18, 17, 16, 15, 14): Valid if any dart hit that number
            [20, 19, 18, 17, 16, 15, 14].forEach(num => {
                if (numbers.includes(num)) {
                    validContracts.push(num.toString());
                }
            });

            // Side: 3 adjacent segments
            if (areAdjacent(darts[0], darts[1], darts[2])) {
                validContracts.push('side');
            }

            // 3 in a Row: 3 consecutive numbers
            if (areConsecutive(numbers[0], numbers[1], numbers[2])) {
                validContracts.push('3row');
            }

            // Color: 3 different colors
            const colors = darts.map(d => getDartColor(d)).filter(c => c !== null);
            const uniqueColors = new Set(colors);
            if (uniqueColors.size >= 3) {
                validContracts.push('color');
            }

            // Double: Any double hit
            if (modifiers.includes('double')) {
                validContracts.push('double');
            }

            // Triple: Any triple hit
            if (modifiers.includes('triple')) {
                validContracts.push('triple');
            }

            // 57: Exactly 57 points
            const total = darts.reduce((sum, d) => sum + d.score, 0);
            if (total === 57) {
                validContracts.push('57');
            }

            // Bull: Bullseye hit (25 or 50)
            if (numbers.includes(25)) {
                validContracts.push('bull');
            }

            return validContracts;
        }

        // Calculate score for a specific contract given the darts
        function calculateContractScore(darts, contractId) {
            if (!darts || darts.length === 0) return 0;

            // For numeric contracts (20, 19, 18, 17, 16, 15, 14), only count darts that hit that number
            const numericContract = parseInt(contractId);
            if (!isNaN(numericContract)) {
                let score = 0;
                for (let dart of darts) {
                    if (dart.number === numericContract) {
                        score += dart.score;
                    }
                }
                return score;
            }

            // Special handling for specific contracts
            switch (contractId) {
                case 'double':
                    // Only count darts that are doubles
                    return darts.filter(d => d.modifier === 'double').reduce((sum, d) => sum + d.score, 0);

                case 'triple':
                    // Only count darts that are triples
                    return darts.filter(d => d.modifier === 'triple').reduce((sum, d) => sum + d.score, 0);

                case 'bull':
                    // Only count darts that hit the bull (number 25)
                    return darts.filter(d => d.number === 25).reduce((sum, d) => sum + d.score, 0);

                default:
                    // For other contracts (capital, side, 3row, color, 57), return the total
                    return darts.reduce((sum, d) => sum + d.score, 0);
            }
        }

        // Check if darts meet the contract requirements (for Classic mode)
        function checkContractRequirements(darts, contractId) {
            if (!darts || darts.length === 0) return false;

            const numbers = darts.map(d => d.number);
            const modifiers = darts.map(d => d.modifier);

            switch (contractId) {
                case 'capital':
                    return true; // Capital always succeeds if darts are entered

                case 'side':
                    // Must hit 3 adjacent segments
                    return areAdjacent(darts[0], darts[1], darts[2]);

                case '3row':
                    // Must hit 3 consecutive numbers
                    return areConsecutive(numbers[0], numbers[1], numbers[2]);

                case 'color':
                    // Must hit 3 different colors
                    const colors = darts.map(d => getDartColor(d)).filter(c => c !== null);
                    const uniqueColors = new Set(colors);
                    return uniqueColors.size >= 3;

                case 'double':
                    // Must hit at least one double
                    return modifiers.includes('double');

                case 'triple':
                    // Must hit at least one triple
                    return modifiers.includes('triple');

                case '57':
                    // Must score exactly 57
                    const total = darts.reduce((sum, d) => sum + d.score, 0);
                    return total === 57;

                case 'bull':
                    // Must hit bullseye
                    return numbers.includes(25);

                default:
                    // For numeric contracts, check if at least one dart hit the number
                    const targetNumber = parseInt(contractId);
                    if (!isNaN(targetNumber)) {
                        return numbers.includes(targetNumber);
                    }
                    return false;
            }
        }

        // ==================== SCORE VALIDATION ====================

        function getValidationRule(contractId) {
            const rules = {
                'en': {
                    'capital': { validate: () => true, message: '' },
                    '20': { validate: (score) => score === 0 || score % 20 === 0, message: '0 or a multiple of 20 (20, 40, 60)' },
                    'side': { validate: () => true, message: '' },
                    '19': { validate: (score) => score === 0 || score % 19 === 0, message: '0 or a multiple of 19 (19, 38, 57)' },
                    '3row': { validate: () => true, message: '' },
                    '18': { validate: (score) => score === 0 || score % 18 === 0, message: '0 or a multiple of 18 (18, 36, 54)' },
                    'color': { validate: () => true, message: '' },
                    '17': { validate: (score) => score === 0 || score % 17 === 0, message: '0 or a multiple of 17 (17, 34, 51)' },
                    'double': { validate: (score) => score === 0 || score % 2 === 0, message: '0 or an even number (any double)' },
                    '16': { validate: (score) => score === 0 || score % 16 === 0, message: '0 or a multiple of 16 (16, 32, 48)' },
                    'triple': { validate: () => true, message: '' },
                    '15': { validate: (score) => score === 0 || score % 15 === 0, message: '0 or a multiple of 15 (15, 30, 45)' },
                    '57': { validate: (score) => score === 0 || score === 57, message: '0 or exactly 57' },
                    '14': { validate: (score) => score === 0 || score % 14 === 0, message: '0 or a multiple of 14 (14, 28, 42)' },
                    'bull': { validate: (score) => score === 0 || score === 25 || score === 50, message: '0, 25, or 50' }
                },
                'fr': {
                    'capital': { validate: () => true, message: '' },
                    '20': { validate: (score) => score === 0 || score % 20 === 0, message: '0 ou un multiple de 20 (20, 40, 60)' },
                    'side': { validate: () => true, message: '' },
                    '19': { validate: (score) => score === 0 || score % 19 === 0, message: '0 ou un multiple de 19 (19, 38, 57)' },
                    '3row': { validate: () => true, message: '' },
                    '18': { validate: (score) => score === 0 || score % 18 === 0, message: '0 ou un multiple de 18 (18, 36, 54)' },
                    'color': { validate: () => true, message: '' },
                    '17': { validate: (score) => score === 0 || score % 17 === 0, message: '0 ou un multiple de 17 (17, 34, 51)' },
                    'double': { validate: (score) => score === 0 || score % 2 === 0, message: '0 ou un nombre pair (n\'importe quel double)' },
                    '16': { validate: (score) => score === 0 || score % 16 === 0, message: '0 ou un multiple de 16 (16, 32, 48)' },
                    'triple': { validate: () => true, message: '' },
                    '15': { validate: (score) => score === 0 || score % 15 === 0, message: '0 ou un multiple de 15 (15, 30, 45)' },
                    '57': { validate: (score) => score === 0 || score === 57, message: '0 ou exactement 57' },
                    '14': { validate: (score) => score === 0 || score % 14 === 0, message: '0 ou un multiple de 14 (14, 28, 42)' },
                    'bull': { validate: (score) => score === 0 || score === 25 || score === 50, message: '0, 25 ou 50' }
                },
                'es': {
                    'capital': { validate: () => true, message: '' },
                    '20': { validate: (score) => score === 0 || score % 20 === 0, message: '0 o un m√∫ltiplo de 20 (20, 40, 60)' },
                    'side': { validate: () => true, message: '' },
                    '19': { validate: (score) => score === 0 || score % 19 === 0, message: '0 o un m√∫ltiplo de 19 (19, 38, 57)' },
                    '3row': { validate: () => true, message: '' },
                    '18': { validate: (score) => score === 0 || score % 18 === 0, message: '0 o un m√∫ltiplo de 18 (18, 36, 54)' },
                    'color': { validate: () => true, message: '' },
                    '17': { validate: (score) => score === 0 || score % 17 === 0, message: '0 o un m√∫ltiplo de 17 (17, 34, 51)' },
                    'double': { validate: (score) => score === 0 || score % 2 === 0, message: '0 o un n√∫mero par (cualquier doble)' },
                    '16': { validate: (score) => score === 0 || score % 16 === 0, message: '0 o un m√∫ltiplo de 16 (16, 32, 48)' },
                    'triple': { validate: () => true, message: '' },
                    '15': { validate: (score) => score === 0 || score % 15 === 0, message: '0 o un m√∫ltiplo de 15 (15, 30, 45)' },
                    '57': { validate: (score) => score === 0 || score === 57, message: '0 o exactamente 57' },
                    '14': { validate: (score) => score === 0 || score % 14 === 0, message: '0 o un m√∫ltiplo de 14 (14, 28, 42)' },
                    'bull': { validate: (score) => score === 0 || score === 25 || score === 50, message: '0, 25 o 50' }
                }
            };

            return rules[currentLang][contractId] || { validate: () => true, message: '' };
        }

        function validateScore(score, contractId) {
            const rule = getValidationRule(contractId);
            return rule.validate(score);
        }

        function showValidationError(contractId) {
            const rule = getValidationRule(contractId);
            const contractName = getContractName(contractId);
            const message = t('invalidScoreDetail')
                .replace('{contract}', contractName)
                .replace('{rule}', rule.message);
            alert(message);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            applyTranslations();
            buildRulesGrid();

            // Try to load saved game state
            const loaded = loadGameState();
            if (loaded) {
                console.log('Game state restored from localStorage');
            }
        });
    </script>
</body>
</html>
